version: '3'


vars: 
  VERSION: 
    sh: git describe --tags --always
  PINGER_IMAGE: chronark/planetfall-pinger
  SCHEDULER_IMAGE: chronark/planetfall-scheduler

tasks:
  clear:
    cmds:
      - rm -rf ./**/node_modules
      - rm -rf ./**/dist
      - rm -rf ./**/.next
      - rm -rf ./**/.turbo
  install:
    deps: 
      - clear
    cmds:
      - pnpm install
  build:
    deps:
      - install
    cmds:
      - pnpm build
  
  deploy:
    deps:
      - clear
      - install
    env:
          TF_VAR_pinger_image: "{{.PINGER_IMAGE}}:{{.VERSION}}"
          TF_VAR_scheduler_image: "{{.SCHEDULER_IMAGE}}:{{.VERSION}}"
    cmds:
      - task: build-docker
        vars:
          DOCKERFILE: svc/proxy/Dockerfile
          IMAGE: chronark/planetfall-pinger
          
      - task: build-docker
        vars:
          DOCKERFILE: svc/scheduler/Dockerfile
          IMAGE: chronark/planetfall-scheduler
        

      - terraform -chdir=deployment init -upgrade
      - terraform -chdir=deployment apply -var-file=".tfvars" -auto-approve
       
     
        
  

  build-docker:
    internal: true
    run: when_changed
    cmds:
      - docker build --platform=linux/amd64 -t {{.IMAGE}}:{{.VERSION}} -t {{.IMAGE}}:latest -f {{.DOCKERFILE}} .
      - docker push {{.IMAGE}}:{{.VERSION}}
      - docker push {{.IMAGE}}:latest
    