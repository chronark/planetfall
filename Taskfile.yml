version: '3'


vars: 
  VERSION: 
    sh: git describe --tags --always
  CHECK_RUNNER_IMAGE: chronark/planetfall-check-runner

tasks:
  clear:
    cmds:
      - rm -rf ./**/node_modules
      - rm -rf ./**/dist
      - rm -rf ./**/.next
      - rm -rf ./**/.turbo
  install:
    deps: 
      - clear
    cmds:
      - pnpm install
  build:
    deps:
      - install
    cmds:
      - pnpm build
  
  deploy:
    deps:
      - clear
    env:
          TF_VAR_check_runner_image: "{{.CHECK_RUNNER_IMAGE}}:{{.VERSION}}"
    cmds:
      - task: build-pinger
       
      - terraform -chdir=deployment init -upgrade
      - terraform -chdir=deployment apply -var-file=".tfvars" -auto-approve
       
  
  build-pinger:
    cmds:
      - docker build --platform=linux/amd64 -t {{.CHECK_RUNNER_IMAGE}}:{{.VERSION}} -t {{.CHECK_RUNNER_IMAGE}}:latest -f ./apps/proxy/Dockerfile .
      - docker push {{.CHECK_RUNNER_IMAGE}}:{{.VERSION}}
      - docker push {{.CHECK_RUNNER_IMAGE}}:latest
    